<html xmlns="http://www.w3.org/1999/html">
<!--
    Test page to download the latest TAR library without the use of a package system like npm.
-->
<style>
  body {
    background-color: #00BCD4;
  }

  .line, title {
    font-size: 20px;
    padding: 0;
    margin: 0;
    margin-top: 0.5em;
    margin-left: 10em;
    margin-right: 10em;
  }
  .line {
    text-align: left;
  }
  .title {
    text-align: center;
  }
</style>
<body>
<div class="title">TAR Testing:</div>
<div class="title">
  <a href="javascript:showTruexAd()">Press 'X' or space to show the next true[X] ad</a>
  <div style="width: 0.5em; display: inline-block"></div>
</div>
<div id="ad-display" class="line"></div>
<div id="ad-events"></div>
<script type="application/javascript">
  var oldSplit = String.prototype.split;
  var oldRegExp = window.RegExp;

  function getSplitTest() {
      var testRegexp = /\s+/;
      var pattern = "a b c";

      return function(ctx, r) {
          if (!r) r = testRegexp;
          console.log('test split: ' + ctx + ': ' + JSON.stringify(pattern.split(r)));
          return r;
      }
  }

  var testSplit = getSplitTest();
  testSplit('before TAR');
</script>
<!-- Use the latest TAR or just version 1.x.x if we want to ensure no breaking changes from higher versions. -->
<!--<script type="application/javascript" src="https://cdn.jsdelivr.net/npm/@truex/ctv-ad-renderer@latest"></script>-->
<!--<script type="application/javascript" src="https://cdn.jsdelivr.net/npm/@truex/ctv-ad-renderer@1"></script>-->
<!-- Use specific branch for testing changes. -->
<script type="application/javascript" src="http://192.168.1.82:8080/tar.js"></script>
<script type="application/javascript">
    var newSplit = String.prototype.split;
    var newRegExp = window.RegExp;

    if (newSplit !== oldSplit) {
        console.warn('split has changed');
    } else {
        console.log('split is ok');
    }
    var oldTestRegexp = testSplit('after TAR');
    console.log('test regexp classes match: old: ' + (oldTestRegexp.constructor == oldRegExp)
        + " new: " + (oldTestRegexp.constructor == newRegExp));

    var testRegexp2 = /\s+/;
    testSplit('with new', testRegexp2);

    if (newRegExp !== oldRegExp) {
        console.warn('RegExp has changed');
    } else {
        console.log('RegExp is ok');
    }
    console.log('test regexp2 classes match: old: ' + (testRegexp2.constructor == oldRegExp)
        + " new: " + (testRegexp2.constructor == newRegExp));

    var body = document.body;
    var adDetail = document.getElementById('ad-display');
    var adEventLog = document.getElementById('ad-events');

    var nextAdIndex = 0;

    var testAds = [
        "https://qa-get.truex.com/22105de992284775a56f28ca6dac16c667e73cd0/vast/config?dimension_1=sample-video&dimension_2=0&dimension_3=sample-video&dimension_4=1234&dimension_5=evergreen&stream_position=preroll&stream_id=1234",
        "https://qa-get.truex.com/22105de992284775a56f28ca6dac16c667e73cd0/vast/config?dimension_1=sample-video&dimension_2=1&dimension_3=sample-video&dimension_4=5678&dimension_5=evergreen&stream_position=midroll&stream_id=5678"
    ];

    // to prevent double launching of TruexAdRenderer in this test page.
    var isTruexActive = false;

    body.addEventListener('keydown', onKeyAction);
    body.addEventListener('touchstart', showTruexAd)
    body.addEventListener('click', showTruexAd)
    body.focus();

    function onKeyAction(event) {
        var keyCode = event.keyCode;
        var selectKey = [13, 32].indexOf(keyCode) >= 0; // i.e. enter or space
        if (selectKey) {
            showTruexAd();
        }
    }

    function showTruexAd() {
        if (!isTruexActive) {
            isTruexActive = true;
            var vastConfigUrl = testAds[nextAdIndex];

            adDetail.innerText = "Testing Ad " + (nextAdIndex + 1);

            nextAdIndex = (nextAdIndex + 1) % testAds.length;

            var interactiveAd = new TruexInteractiveAd(vastConfigUrl);
            interactiveAd.show();
        }
    }

    function TruexInteractiveAd(vastConfigUrl) {
        var adFreePod = false;
        var tar;
        var adOverlay;

        for(;;) {
            const firstEvent = adEventLog.firstChild;
            if (!firstEvent) break;
            adEventLog.removeChild(firstEvent);
        }

        this.show = show;

        function show() {
            try {
                //videoController.pause(); // i.e. in a real media app

                // Explore options as needed
                const options = {
                    // userAdvertisingId: someUserOrAdvertisingId,
                    // supportsUserCancelStream: true // i.e. user backing out of an ad will cancel the entire video

                    // Key mappings can be customized for new platforms:
                    keyMapOverrides: {
                        select: [68, 32], // D or space
                        back: 66, // B
                        moveUp: 69, // E
                        moveDown: 88, // X
                        moveLeft: 83, // S
                        moveRight: 70 // F
                    }
                };

                var TAR = TruexAdRenderer['TruexAdRenderer']; // extract the constructor from the truex module.
                tar = new TAR(vastConfigUrl, options);
                tar.subscribe(handleAdEvent);

                return tar.init()
                .then(vastConfig => {
                    return tar.start(vastConfig);
                })
                .then(newAdOverlay => {
                    adOverlay = newAdOverlay;
                })
                .catch(handleAdError);
            } catch (err) {
                handleAdError(err);
            }
        }

        function handleAdEvent(event) {
            const adEvents = tar.adEvents;

            var logItem = document.createElement('div');
            logItem.classList.add('line');
            logItem.innerText = JSON.stringify(event);
            adEventLog.appendChild(logItem);

            switch (event.type) {
                case adEvents.adError:
                    handleAdError(event.errorMessage);
                    break;

                case adEvents.adStarted:
                    // Choice card loaded and displayed.
                    //videoController.showLoadingSpinner(false); // i.e. in a real media app
                    break;

                case adEvents.optIn:
                    // User started the engagement experience
                    break;

                case adEvents.optOut:
                    // User cancelled out of the choice card, either explicitly, or implicitly via a timeout.
                    break;

                case adEvents.adFreePod:
                    adFreePod = true; // the user did sufficient interaction for an ad credit
                    break;

                case adEvents.userCancel:
                    // User backed out of the ad, now showing the choice card again.
                    break;

                case adEvents.userCancelStream:
                    // User backed out of the choice card, which means backing out of the entire video.
                    closeAdOverlay();
                    //videoController.closeVideoAction(); // i.e. in a real media app
                    break;

                case adEvents.noAdsAvailable:
                case adEvents.adCompleted:
                    // Ad is not available, or has completed. Depending on the adFreePod flag, either the main
                    // video or the ad fallback videos are resumed.
                    closeAdOverlay();
                    resumePlayback();
                    break;
            }
        }

        function handleAdError(errOrMsg) {
            console.error('ad error: ' + errOrMsg);
            if (tar) {
                // Ensure the ad is no longer blocking back or key events, etc.
                tar.stop();
            }
            closeAdOverlay();
            resumePlayback();
        }

        function closeAdOverlay() {
            console.log('truex ad closed');
            isTruexActive = false;
            //videoController.showLoadingSpinner(false); // i.e. in a real media app

            var afterSplit = String.prototype.split;
            var afterRegExp = window.RegExp;

            String.prototype.split = oldSplit;
            window.RegExp = oldRegExp;

            function testClass(ctx, r) {
                console.log('test regexp classes match: ' + ctx
                    + ' old: ' + (r.constructor == oldRegExp)
                    + " new: " + (r.constructor == newRegExp)
                    + " after: " + (r.constructor == afterRegExp)
                );
            }

            var oldTestRegexp = testSplit('after ad');
            var testRegexp3 = /\s+/;
            testSplit('after ad, regexp3', testRegexp3);
            var testRegexp4 = new RegExp('\\s+');
            testSplit('after ad, regexp4', testRegexp4);
            console.log("new test regexp4: " + JSON.stringify("a b c".split(testRegexp4)));

            testClass('oldR', oldTestRegexp);
            testClass('r4', testRegexp4);

            console.log("oldSplit: " + JSON.stringify(oldSplit.call("a b c"), oldTestRegexp));
            console.log("oldSplit: " + JSON.stringify(oldSplit.call("a b c"), testRegexp4));
            console.log("newSplit: " + JSON.stringify(newSplit.call("a b c"), oldTestRegexp));
            console.log("newSplit: " + JSON.stringify(newSplit.call("a b c"), testRegexp4));
        }

        function resumePlayback() {
            if (adFreePod) {
                console.log("The user has the ad credit, skip over the fallback ad videos.");
                // videoController.skipAd(adBreak);
            }

            console.log("reusming playback")
            // videoController.startVideoLater();
        }
    }
</script>
</body>
</html>
